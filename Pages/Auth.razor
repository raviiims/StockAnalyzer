@page "/auth"
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Components
@rendermode @(new InteractiveServerRenderMode())
@inject IConfiguration Config
@inject IntradayUpstox.Services.UpstoxService Upstox
@inject IntradayUpstox.Services.TokenStore TokenStore
@inject NavigationManager Navigation

<h3>Upstox Authentication</h3>

@if (TokenStore.HasToken)
{
    <div class="alert alert-success">
        Access token received! You are authenticated and can now use the application.
    </div>
}

<p>
  Click the link below to open Upstox login (it will redirect to the redirect URI and show the code).
</p>

<p>
  <a class="btn btn-primary" href="@AuthorizeUrl" target="_self">Open Upstox Login</a>
</p>

<hr />

<h5>Paste the authorization <code>code</code> you received here (or copy from the redirect page):</h5>
<input @bind="authCode" class="form-control" />
<button class="btn btn-success mt-2" @onclick="ExchangeCode">Exchange Code for Token</button>

@if (message != null)
{
    <div class="alert alert-info mt-2">@message</div>
}

@code {
    string authCode = string.Empty;
    string? message;

    string AuthorizeUrl => Config["Upstox:AuthorizeUrl"]?
        .Replace("{client_id}", Config["Upstox:ClientId"] ?? "")
        .Replace("{redirect_uri}", Config["Upstox:RedirectUri"] ?? "") ?? "";

    protected override void OnInitialized()
    {
        // Check if there's a code in the query string
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        if (Microsoft.AspNetCore.WebUtilities.QueryHelpers.ParseQuery(uri.Query).TryGetValue("code", out var codeValue) && !string.IsNullOrEmpty(codeValue))
        {
            authCode = codeValue.ToString();
        }
    }

    async Task ExchangeCode()
    {
        if (string.IsNullOrWhiteSpace(authCode)) 
        { 
            message = "Enter the code."; 
            StateHasChanged();
            return; 
        }
        message = null;
        StateHasChanged();
        var ok = await Upstox.ExchangeCodeForTokenAsync(authCode.Trim());
        if (ok)
        {
            message = "Token obtained and saved successfully!";
            StateHasChanged();
            // Redirect to intraday after a short delay
            await Task.Delay(1000);
            Navigation.NavigateTo("/intraday");
        }
        else
        {
            message = "Failed to exchange code. Check logs.";
            StateHasChanged();
        }
    }
}
